<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>ğŸ” eBay PokÃ©mon å¡ç‰‡æˆäº¤èµ°å‹¢åœ–</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 1.5rem;
            max-width: 800px;
            margin: auto;
        }

        h1 {
            color: #0064d2;
        }

        input,
        button {
            font-size: 1rem;
            padding: 7px;
        }

        canvas {
            margin-top: 2rem;
            width: 100%;
            height: 400px;
        }

        #loading {
            display: none;
        }
    </style>
</head>

<body>
    <h1>ğŸ“ˆ PokÃ©mon å¡ç‰‡æˆäº¤èµ°å‹¢ (eBay API)</h1>
    <p>è¼¸å…¥å¡ç‰‡é—œéµå­—ï¼ˆä¾‹å¦‚ <b>Pokemon Pikachu UPC PSA 10</b>ï¼‰å³æ™‚æŸ¥çœ‹æœ€è¿‘æˆäº¤åƒ¹</p>
    <input type="text" id="query" placeholder="è¼¸å…¥å¡å" style="width:70%">
    <button onclick="search()">æŸ¥è©¢</button>
    <p id="loading">âŒ› è«‹ç¨å€™ï¼Œæ­£åœ¨å¾ eBay å–å¾—è³‡æ–™â€¦</p>
    <canvas id="chart"></canvas>

    <script>
        async function search() {
            const query = document.getElementById("query").value.trim();
            if (!query) return alert("è«‹è¼¸å…¥é—œéµå­—ï¼");
            document.getElementById("loading").style.display = "block";

            const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
            const data = await res.json();
            document.getElementById("loading").style.display = "none";

            console.log("API Response:", data); // Debug log

            if (!data.itemSummaries) {
                console.error("No itemSummaries found:", data);
                return alert("æŸ¥ç„¡çµæœï¼Œæˆ– API å›å‚³éŒ¯èª¤ã€‚");
            }

            console.log("Total items:", data.itemSummaries.length); // Debug log

            const items = data.itemSummaries
                .filter(it => it.price)
                .map((it, index) => ({
                    date: it.itemEndDate ? new Date(it.itemEndDate) : new Date(it.itemCreationDate),
                    price: parseFloat(it.price.value),
                    index: index + 1
                }))
                .sort((a, b) => a.date - b.date);

            console.log("Filtered items:", items.length, items); // Debug log

            if (items.length === 0) {
                return alert("æ²’æœ‰æ‰¾åˆ°æœ‰åƒ¹æ ¼çš„å•†å“");
            }

            const labels = items.map(i => i.date.toLocaleDateString());
            const prices = items.map(i => i.price);

            drawChart(query, labels, prices);
        }

        function drawChart(title, labels, prices) {
            console.log("drawChart called with:", { title, labels, prices }); // Debug log

            const canvas = document.getElementById("chart");
            if (!canvas) {
                console.error("Canvas element not found!");
                return;
            }

            const ctx = canvas.getContext("2d");
            if (!ctx) {
                console.error("Cannot get 2D context!");
                return;
            }

            if (typeof Chart === 'undefined') {
                console.error("Chart.js not loaded!");
                return alert("Chart.js è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
            }

            if (window.chart && typeof window.chart.destroy === 'function') {
                window.chart.destroy();
            }

            window.chart = new Chart(ctx, {
                type: "line",
                data: {
                    labels,
                    datasets: [{
                        label: `${title} æœ€è¿‘æˆäº¤åƒ¹ (USD)`,
                        data: prices,
                        borderColor: "#0064d2",
                        tension: 0.25,
                        fill: false
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: false } },
                    responsive: true
                }
            });
        }
    </script>
</body>

</html>